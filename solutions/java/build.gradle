buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id 'java'
    id 'com.github.ben-manes.versions' version '0.20.0'
    id 'com.avast.gradle.docker-compose' version '0.8.13'
}

repositories {
    mavenCentral()
}

sourceCompatibility = JavaVersion.VERSION_1_9
targetCompatibility = JavaVersion.VERSION_1_9

test {
    useJUnitPlatform()
}

ext {
    lombokVersion = '1.18.4'
    junitVersion = '5.3.2'
    springBootVersion = '2.1.2.RELEASE'
}

dependencies {
    annotationProcessor "org.projectlombok:lombok:$lombokVersion"

    compileOnly(
            "org.projectlombok:lombok:$lombokVersion",
    )

    implementation(
            'com.google.guava:guava:27.0.1-jre',
            'cglib:cglib-full:2.0.2',
            'guru.nidi:graphviz-java:0.8.0',
            'com.rabbitmq:amqp-client:5.5.3',
            "org.springframework.boot:spring-boot-starter-aop:$springBootVersion",
            "org.springframework.boot:spring-boot-starter-data-jpa:$springBootVersion",
    )

    runtimeOnly(
            'com.h2database:h2:1.4.197',
    )

    testImplementation(
            "org.junit.jupiter:junit-jupiter-api:$junitVersion",
            'org.assertj:assertj-core:3.11.1',
            'org.awaitility:awaitility:3.1.5',
            "org.springframework.boot:spring-boot-starter-test:$springBootVersion",
    )

    testRuntimeOnly(
            "org.junit.jupiter:junit-jupiter-engine:$junitVersion",
    )
}

dependencyUpdates.resolutionStrategy {
    componentSelection { rules ->
        rules.all { ComponentSelection selection ->
            ['alpha', 'beta', 'rc', 'cr', 'm', 'preview'].any { qualifier ->
                selection.candidate.version ==~ /(?i).*[.-]${qualifier}[.\d-]*/
            }
        }
    }
}

dockerCompose {
    useComposeFiles = []
}

def middlewares = ['rabbitmq']

middlewares.each { middleware ->

    tasks.create(name: "start${middleware.capitalize()}", group: 'docker', dependsOn: ['composeUp']) {
        dockerCompose.useComposeFiles += "docker/docker-compose-${middleware}.yml"
    }
}