# 索引优化

## 最左匹配原则

假设我们有一张表，其建表语句如下，它有3列和一个索引。

```sql
create table people (
  name    varchar(20),
  country varchar(20),
  age     int,
  key (name, country, age)
);
```

如果我们希望查询可以用到索引，那么查询条件中的列必须精确匹配索引的左边一个或连续的多个列。

以下几个查询是可以利用到索引的。

```sql
-- 用到了索引的第1列
select * from people where name = 'Peter';
+----+-------------+--------+------------+------+---------------+------+---------+-------+------+----------+-------------+
| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref   | rows | filtered | Extra       |
+----+-------------+--------+------------+------+---------------+------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | people | NULL       | ref  | name          | name | 83      | const |    1 |   100.00 | Using index |
+----+-------------+--------+------------+------+---------------+------+---------+-------+------+----------+-------------+
-- 用到了索引的第1列和第2列
select * from people where name = 'Peter' and country = 'China';
+----+-------------+--------+------------+------+---------------+------+---------+-------------+------+----------+-------------+
| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref         | rows | filtered | Extra       |
+----+-------------+--------+------------+------+---------------+------+---------+-------------+------+----------+-------------+
|  1 | SIMPLE      | people | NULL       | ref  | name          | name | 166     | const,const |    1 |   100.00 | Using index |
+----+-------------+--------+------------+------+---------------+------+---------+-------------+------+----------+-------------+

-- 用到了索引的第1列、第2列和第3列
select * from people where name = 'Peter' and country = 'China' and age = 18;
+----+-------------+--------+------------+------+---------------+------+---------+-------------------+------+----------+-------------+
| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref               | rows | filtered | Extra       |
+----+-------------+--------+------------+------+---------------+------+---------+-------------------+------+----------+-------------+
|  1 | SIMPLE      | people | NULL       | ref  | name          | name | 171     | const,const,const |    1 |   100.00 | Using index |
+----+-------------+--------+------------+------+---------------+------+---------+-------------------+------+----------+-------------+
```

以下语句中虽然条件的顺序不完全按照索引中列的顺序，但依然可以用到索引，因为MySQL的优化器会对索引的选择进行分析。

```sql
select * from people where age = 18 and country = 'China' and name = 'Peter';
```

以下查询只能用到部分索引，可以看到它用到的索引的长度和`select * from people where name = 'Peter';`用到的索引长度是一样的，说明索引只有第1列用到了。在`Extra`列中显示了`Using where; Using index`，说明是用了一部分索引后再逐行扫描。

```sql
-- 只能用到索引的第1列，因为没有匹配中间的country列
select * from people where name = 'Peter' and age = 18;
+----+-------------+--------+------------+------+---------------+------+---------+-------+------+----------+--------------------------+
| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref   | rows | filtered | Extra                    |
+----+-------------+--------+------------+------+---------------+------+---------+-------+------+----------+--------------------------+
|  1 | SIMPLE      | people | NULL       | ref  | name          | name | 83      | const |    1 |    20.00 | Using where; Using index |
+----+-------------+--------+------------+------+---------------+------+---------+-------+------+----------+--------------------------+
```

以下查询不能利用索引。

```sql
select * from people where country = 'China';
+----+-------------+--------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
| id | select_type | table  | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
+----+-------------+--------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
|  1 | SIMPLE      | people | NULL       | index | NULL          | name | 171     | NULL |    5 |    20.00 | Using where; Using index |
+----+-------------+--------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
```