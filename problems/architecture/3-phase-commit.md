# 三阶段提交

三阶段提交协议是[二阶段提交协议](2-phase-commit.md)的改进，它把二阶段提交协议中的提交事务请求阶段进一步拆分，有CanCommit、PreCommit和DoCommit三个阶段。

## 阶段一：CanCommit

第一阶段有以下几个步骤。

1. 协调者向参与者们发送一个包含事务内容的`canCommit`消息，询问是否可以执行事务提交操作，然后等待参与者的响应。
2. 参与者们如果认为自己可以顺利执行事务那么就反馈`Yes`并进入预备状态，否则反馈`No`。

与二阶段提交协议不同的是，在三阶段提交协议的第一个阶段中，参与者们不会执行事务。

## 阶段二：PreCommit

如果阶段一中参与者都反馈`Yes`，那么进入下面执行事务预提交的步骤。

1. 协调者向参与者们发送`preCommit`消息，并进入`Prepared`状态。
2. 参与者们执行事务，但**不提交**。
3. 如果参与者们成功执行了事务，那么就反馈给协调者`Ack`消息，并等待最终的指令。

相反，如果协调者收到一个`No`反馈或者部分参与者反馈超时了，那么就执行中断事务的步骤。

1. 协调者向所有参与者们发送`abort`请求。
2. 接收到`abort`请求的参与者或者在等待协调者请求过程中超时的参与者都中断事务。

## 阶段三：DoCommit



## 优缺点

